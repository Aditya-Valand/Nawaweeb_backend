{
  "permissions": {
    "allow": [
      "Bash(git add:*)",
      "Bash(\"/c/Users/bhati/OneDrive/Desktop/nawaweeb backend/.claude/worktrees/goofy-sanderson/src/controllers/orderController.js\" <<'EOF'\nconst { supabase } = require\\('../config/db'\\);\n\nconst createOrder = async \\(req, res\\) => {\n  try {\n    const userId = req.user.id;\n    const { items, shipping_address } = req.body;\n\n    if \\(!items || !Array.isArray\\(items\\) || items.length === 0\\) {\n      return res.status\\(400\\).json\\({ success: false, message: 'Order items are required' }\\);\n    }\n\n    const variantIds = items.map\\(item => item.variant_id\\);\n    const { data: variants, error: variantError } = await supabase\n      .from\\('product_variants'\\)\n      .select\\('id, stock_quantity, price_override, product_id, products\\(price, title\\)'\\)\n      .in\\('id', variantIds\\);\n\n    if \\(variantError || variants.length !== variantIds.length\\) {\n      return res.status\\(400\\).json\\({ success: false, message: 'Invalid variants' }\\);\n    }\n\n    const orderItems = [];\n    let totalAmount = 0;\n\n    for \\(const item of items\\) {\n      const variant = variants.find\\(v => v.id === item.variant_id\\);\n      if \\(variant.stock_quantity < item.quantity\\) {\n        return res.status\\(400\\).json\\({ \n          success: false, \n          message: `Insufficient stock for ${variant.products.title}` \n        }\\);\n      }\n      const price = variant.price_override || variant.products.price;\n      orderItems.push\\({ variant_id: variant.id, quantity: item.quantity, price_at_purchase: price }\\);\n      totalAmount += price * item.quantity;\n    }\n\n    const { data: order, error: orderError } = await supabase\n      .from\\('orders'\\)\n      .insert\\({ user_id: userId, total_amount: totalAmount, status: 'pending', payment_status: 'pending', shipping_address }\\)\n      .select\\(\\)\n      .single\\(\\);\n\n    if \\(orderError\\) {\n      return res.status\\(500\\).json\\({ success: false, message: 'Failed to create order' }\\);\n    }\n\n    const orderItemsWithOrderId = orderItems.map\\(item => \\({ ...item, order_id: order.id }\\)\\);\n    const { error: itemsError } = await supabase.from\\('order_items'\\).insert\\(orderItemsWithOrderId\\);\n\n    if \\(itemsError\\) {\n      await supabase.from\\('orders'\\).delete\\(\\).eq\\('id', order.id\\);\n      return res.status\\(500\\).json\\({ success: false, message: 'Failed to create order items' }\\);\n    }\n\n    for \\(const item of items\\) {\n      const variant = variants.find\\(v => v.id === item.variant_id\\);\n      await supabase\n        .from\\('product_variants'\\)\n        .update\\({ stock_quantity: variant.stock_quantity - item.quantity }\\)\n        .eq\\('id', item.variant_id\\);\n    }\n\n    return res.status\\(201\\).json\\({ success: true, message: 'Order created successfully', data: { order } }\\);\n  } catch \\(error\\) {\n    console.error\\('Create order error:', error\\);\n    return res.status\\(500\\).json\\({ success: false, message: 'Internal server error' }\\);\n  }\n};\n\nconst getUserOrders = async \\(req, res\\) => {\n  try {\n    const { data: orders, error } = await supabase\n      .from\\('orders'\\)\n      .select\\('*, order_items\\(*, product_variants\\(size, products\\(title, images\\)\\)\\)'\\)\n      .eq\\('user_id', req.user.id\\)\n      .order\\('created_at', { ascending: false }\\);\n\n    if \\(error\\) return res.status\\(400\\).json\\({ success: false, message: error.message }\\);\n    return res.status\\(200\\).json\\({ success: true, count: orders.length, data: { orders } }\\);\n  } catch \\(error\\) {\n    return res.status\\(500\\).json\\({ success: false, message: 'Internal server error' }\\);\n  }\n};\n\nconst getOrderById = async \\(req, res\\) => {\n  try {\n    const { id } = req.params;\n    let query = supabase\n      .from\\('orders'\\)\n      .select\\('*, profiles!orders_user_id_fkey\\(full_name, email\\), order_items\\(*, product_variants\\(size, products\\(title, images\\)\\)\\)'\\)\n      .eq\\('id', id\\);\n\n    if \\(req.user.role !== 'admin'\\) query = query.eq\\('user_id', req.user.id\\);\n\n    const { data: order, error } = await query.single\\(\\);\n\n    if \\(error\\) {\n      if \\(error.code === 'PGRST116'\\) return res.status\\(404\\).json\\({ success: false, message: 'Order not found' }\\);\n      return res.status\\(400\\).json\\({ success: false, message: error.message }\\);\n    }\n\n    return res.status\\(200\\).json\\({ success: true, data: { order } }\\);\n  } catch \\(error\\) {\n    return res.status\\(500\\).json\\({ success: false, message: 'Internal server error' }\\);\n  }\n};\n\nconst getAllOrders = async \\(req, res\\) => {\n  try {\n    if \\(req.user.role !== 'admin'\\) {\n      return res.status\\(403\\).json\\({ success: false, message: 'Access denied. Admin only.' }\\);\n    }\n\n    const { status, limit = 50, offset = 0 } = req.query;\n    let query = supabase\n      .from\\('orders'\\)\n      .select\\('*, profiles!orders_user_id_fkey\\(full_name, email\\), order_items\\(quantity, price_at_purchase\\)', { count: 'exact' }\\)\n      .order\\('created_at', { ascending: false }\\)\n      .range\\(offset, offset + limit - 1\\);\n\n    if \\(status\\) query = query.eq\\('status', status\\);\n\n    const { data: orders, error, count } = await query;\n\n    if \\(error\\) return res.status\\(400\\).json\\({ success: false, message: error.message }\\);\n    return res.status\\(200\\).json\\({ success: true, count, data: { orders } }\\);\n  } catch \\(error\\) {\n    return res.status\\(500\\).json\\({ success: false, message: 'Internal server error' }\\);\n  }\n};\n\nconst updateOrderStatus = async \\(req, res\\) => {\n  try {\n    if \\(req.user.role !== 'admin'\\) {\n      return res.status\\(403\\).json\\({ success: false, message: 'Access denied. Admin only.' }\\);\n    }\n\n    const { id } = req.params;\n    const { status, payment_status } = req.body;\n    const updates = {};\n\n    const validStatuses = ['pending', 'processing', 'shipped', 'delivered', 'cancelled'];\n    const validPaymentStatuses = ['pending', 'paid', 'failed', 'refunded'];\n\n    if \\(status && validStatuses.includes\\(status\\)\\) updates.status = status;\n    if \\(payment_status && validPaymentStatuses.includes\\(payment_status\\)\\) updates.payment_status = payment_status;\n\n    if \\(Object.keys\\(updates\\).length === 0\\) {\n      return res.status\\(400\\).json\\({ success: false, message: 'No valid fields to update' }\\);\n    }\n\n    const { data: order, error } = await supabase\n      .from\\('orders'\\)\n      .update\\(updates\\)\n      .eq\\('id', id\\)\n      .select\\(\\)\n      .single\\(\\);\n\n    if \\(error\\) {\n      if \\(error.code === 'PGRST116'\\) return res.status\\(404\\).json\\({ success: false, message: 'Order not found' }\\);\n      return res.status\\(400\\).json\\({ success: false, message: error.message }\\);\n    }\n\n    return res.status\\(200\\).json\\({ success: true, message: 'Order updated successfully', data: { order } }\\);\n  } catch \\(error\\) {\n    return res.status\\(500\\).json\\({ success: false, message: 'Internal server error' }\\);\n  }\n};\n\nconst cancelOrder = async \\(req, res\\) => {\n  try {\n    const { id } = req.params;\n    const { data: order, error: fetchError } = await supabase\n      .from\\('orders'\\)\n      .select\\('*, order_items\\(variant_id, quantity\\)'\\)\n      .eq\\('id', id\\)\n      .single\\(\\);\n\n    if \\(fetchError || !order\\) {\n      return res.status\\(404\\).json\\({ success: false, message: 'Order not found' }\\);\n    }\n\n    if \\(req.user.role !== 'admin' && order.user_id !== req.user.id\\) {\n      return res.status\\(403\\).json\\({ success: false, message: 'Access denied' }\\);\n    }\n\n    if \\(order.status !== 'pending'\\) {\n      return res.status\\(400\\).json\\({ success: false, message: 'Only pending orders can be cancelled' }\\);\n    }\n\n    const { error: updateError } = await supabase.from\\('orders'\\).update\\({ status: 'cancelled' }\\).eq\\('id', id\\);\n\n    if \\(updateError\\) return res.status\\(500\\).json\\({ success: false, message: 'Failed to cancel order' }\\);\n\n    for \\(const item of order.order_items\\) {\n      const { data: variant } = await supabase\n        .from\\('product_variants'\\)\n        .select\\('stock_quantity'\\)\n        .eq\\('id', item.variant_id\\)\n        .single\\(\\);\n\n      if \\(variant\\) {\n        await supabase\n          .from\\('product_variants'\\)\n          .update\\({ stock_quantity: variant.stock_quantity + item.quantity }\\)\n          .eq\\('id', item.variant_id\\);\n      }\n    }\n\n    return res.status\\(200\\).json\\({ success: true, message: 'Order cancelled successfully' }\\);\n  } catch \\(error\\) {\n    return res.status\\(500\\).json\\({ success: false, message: 'Internal server error' }\\);\n  }\n};\n\nmodule.exports = { createOrder, getUserOrders, getOrderById, getAllOrders, updateOrderStatus, cancelOrder };\nEOF)",
      "Bash(git commit:*)",
      "Bash(git push:*)"
    ]
  }
}
